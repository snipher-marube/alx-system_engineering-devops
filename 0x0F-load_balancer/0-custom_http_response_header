#!/usr/bin/env bash
# Configures Nginx to add X-Served-By header with server hostname in HTTP responses

# Install Nginx if not already installed
apt-get update -y
apt-get install nginx -y

# Get server hostname
HOSTNAME=$(hostname)

# Configure custom header in Nginx
CONFIG_FILE="/etc/nginx/sites-available/default"
HEADER_LINE="add_header X-Served-By $HOSTNAME;"

# Check if header already exists to avoid duplicates
if ! grep -q "X-Served-By" "$CONFIG_FILE"; then
    # Insert the header configuration in the server block
    sed -i "/server_name _;/a \ \ \ \ $HEADER_LINE" "$CONFIG_FILE"
fi

# Test configuration and restart Nginx
if nginx -t; then
    service nginx restart
    echo "Nginx successfully configured with X-Served-By: $HOSTNAME"
else
    echo "Nginx configuration test failed"
    exit 1
fi